# DRE アーキテクチャ

## コンポーネント責務

### Collect

- Google Books API へクエリを発行し、書籍情報を取得する
- クォータ管理（日次上限）を担当する
- 取得結果を後続の Upsert に渡す

### Upsert

- 取得した書籍を DB に保存する
- ISBN-13 をキーとした重複排除を行う
- 既存レコードがあれば更新、なければ挿入

### Select

- 配信対象の書籍を選択する
- 未配信書籍を優先的に選択する
- 未配信がなければ、過去配信済み書籍からフォールバック選択する

### Mail

- 選択された書籍に DeepResearch プロンプトを付与してメール送信する
- 送信成功後、配信済みフラグを更新する

## データフローと依存方向

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│   Collect   │ --> │   Upsert    │ --> │   Select    │ --> │    Mail     │
│ Google Books│     │   SQLite    │     │   SQLite    │     │    SMTP     │
└─────────────┘     └─────────────┘     └─────────────┘     └─────────────┘
      │                   │                   │                   │
      v                   v                   v                   v
  外部 API            内部 DB             内部 DB            外部 SMTP
```

- 依存方向は左から右への単方向
- 各コンポーネントは前段の出力を入力として受け取る
- 外部依存（Google Books API, SMTP）は境界で分離

## ディレクトリ構成

```
dre/
├── config/
│   └── jobs.yaml      # ジョブ設定
├── data/
│   └── app.db         # SQLite データベース（自動生成）
├── .env               # 環境変数
├── .env.example       # 環境変数テンプレート
└── dist/              # ビルド済みファイル
```

## 重要な設計判断

### ISBN-13 での重複排除

- **判断**: ISBN-13 を書籍の一意キーとして採用
- **理由**: 国際的に標準化された識別子であり、重複配信を防止できる
- **トレードオフ**: ISBN のない書籍は収集対象外となる

### 未配信優先 → フォールバック戦略

- **判断**: 未配信書籍を優先し、枯渇時は配信済みから再選択
- **理由**: 新規書籍を優先しつつ、配信停止を回避する
- **トレードオフ**: 長期運用で同じ書籍が再配信される可能性がある

### ジョブ単位の実行間隔管理

- **判断**: ジョブごとに `interval` と `last_run` を管理
- **理由**: クエリごとに適切な頻度で実行し、API クォータを効率的に使用する
- **トレードオフ**: ジョブ数が増えると管理が複雑になる

### 単一配信先

- **判断**: `MAIL_TO` は単一メールアドレスのみ対応
- **理由**: 個人利用を想定した MVP 設計
- **トレードオフ**: 複数配信先には対応しない

## 失敗モードと設計上の扱い

### Google Books API 失敗

- **症状**: ネットワークエラー、認証エラー、レート制限
- **扱い**: エラーログを出力し、該当クエリをスキップ。他のクエリは継続実行
- **復旧**: 次回実行で自動リトライ

### SMTP 失敗

- **症状**: 接続エラー、認証エラー、送信エラー
- **扱い**: エラーログを出力。配信済みフラグは更新しない
- **復旧**: 次回実行で未配信として再選択される

### DB 失敗

- **症状**: SQLite ファイルアクセスエラー、スキーマ不整合
- **扱い**: 致命的エラーとして処理を中断
- **復旧**: `dre db reset` でリセット、またはバックアップから復元

### クォータ超過

- **症状**: `DAILY_BOOKS_API_LIMIT` に到達
- **扱い**: 警告ログを出力し、Collect をスキップ。翌日（JST）に自動リセット
- **復旧**: 手動での介入は不要

## 再実行性・Idempotency

### Collect

- 同一クエリの再実行は安全（API 呼び出しのみ）
- クォータ消費は発生する

### Upsert

- べき等: 同一 ISBN-13 は更新のみ、重複挿入されない

### Select

- べき等ではない: 実行タイミングで選択結果が変わる可能性あり
- ただし、未配信優先のルールは常に適用される

### Mail

- べき等ではない: 同一書籍の再送信は可能
- 配信済みフラグ更新により、通常は再送信されない

## 状態遷移の不変条件

1. **配信フラグ**: `delivered` は `false` → `true` への遷移のみ（リセット操作を除く）
2. **クォータカウンタ**: 日次でリセットされ、0 から `DAILY_BOOKS_API_LIMIT` まで増加
3. **ジョブ実行時刻**: `last_run` は実行ごとに更新され、過去に戻らない
